{
  "name": "Beastcraft-telemetry",
  "tagline": "Santak IPV-2012C UPS, DS18B20 one-wire temperature, ZTE MF823 hostless modem + A5-V11 (MiFi) router and U-blox7 USB GPS monitoring with Grafana and Python on a Raspberry Pi 2 inside a motorhome",
  "body": "# beastcraft-telemetry\r\nSantak `IPV-2012C` UPS, `DS18B20` one-wire temperature, ZTE `MF823` hostless modem + `A5-V11` (MiFi) router and `U-blox7` USB GPS monitoring with Grafana and Python on a Raspberry Pi 2 inside a motorhome.\r\n\r\n### Installation\r\nI've built InfluxDB and Grafanates thanks to a number of existing [guides](https://github.com/ab77/beastcraft-telemetry/blob/master/grafana-armhf/README.md#references).\r\n\r\n    # install InfluxDB\r\n    wget https://s3.eu-central-1.amazonaws.com/beastcraft-telemetry/influxdb_0.10.3-1_armhf.deb\r\n    sudo dpkg -i influxdb_0.10.3-1_armhf.deb\r\n    sudo service influxdb start\r\n    sudo update-rc.d influxdb defaults 95 10\r\n\r\nInstall pre-built Node.js for Raspberry Pi using the handy [Adafruit](https://learn.adafruit.com/node-embedded-development/installing-node-dot-js) guide.\r\n\r\n    # install Grafana\r\n    wget https://s3.eu-central-1.amazonaws.com/beastcraft-telemetry/grafana_3.0.0-pre1_armhf.deb\r\n    sudo dpkg -i grafana_3.0.0-pre1_armhf.deb\r\n    sudo service grafana-server start\r\n    sudo update-rc.d grafana-server defaults 95 10\r\n    \r\n### Configuration\r\nThis repository contains configuration specific to my environment, with five `DS18B20` sensors in total. To personalise it:\r\n\r\n1. run `pip install -r requirement.txt`\r\n2. update `DS18B201` sensor list and database name in `w1_thermy.py`\r\n3. [create database](https://docs.influxdata.com/influxdb/v0.12/introduction/getting_started/) (e.g. `grafana`) for your metrics by running `influx -execute 'CREATE DATABASE grafana;'`\r\n4. optionally [create retention policy](https://docs.influxdata.com/influxdb/v0.12/guides/downsampling_and_retention/) otherwise `default` (store forever) RP applies\r\n\r\n#### Temperature Dashboard\r\n\r\n![temperature dashboard](https://raw.githubusercontent.com/ab77/beastcraft-telemetry/master/static/temperature.png)\r\n\r\n1. add `w1_therm.conf` to `/etc/supervisor/conf.d/` and reload `supervisor` process\r\n2. go to [http://localhost:3000](http://localhost:3000), add a new datasource and configure other options\r\n3. import `temp.json` dashboard and modify it to suit your needs or build your own from scratch (change URLs to suit your environment)\r\n\r\n#### UPS/Inverter Dashboard\r\n\r\n![power dashboard](https://raw.githubusercontent.com/ab77/beastcraft-telemetry/master/static/power.png)\r\n\r\n1. ensure [Network UPS Tools](http://www.networkupstools.org/) is correctly configured to work with the UPS (use `blazer_ser` driver)\r\n2. edit `ups.py` and adjust the default `upsname` (mine is `upsoem`) or pass from the command line using `--ups` parameter\r\n3. add `ups.conf` to `/etc/supervisor/conf.d/` and reload `supervisor` process\r\n4. import `ups.json` dashboard and modify it to suit your needs or build your own from scratch (change URLs to suit your environment)\r\n\r\n#### Traffic Dashboard\r\n\r\n1. install `sflowtool` using [this](http://blog.sflow.com/2011/12/sflowtool.html) or [this](http://blog.belodedenko.me/2014/06/pretty-dashboards-with-fortios-sflow.html) guide\r\n2. add `traffic.conf` to `/etc/supervisor/conf.d/` and reload `supervisor` process\r\n3. import `traffic.json` dashboard and modify it to suit your needs or build your own from scratch\r\n\r\n#### Mobile Broadband Dashboard\r\n\r\n![mobile dashboard](https://raw.githubusercontent.com/ab77/beastcraft-telemetry/master/static/mobilebroadband.png)\r\n\r\n1. update `host` variable in `mobilebroadband.py` to match your ZTE MF823 modem IP address\r\n2. add `mobilebroadband.conf` to `/etc/supervisor/conf.d/` and reload `supervisor` process\r\n3. install `nginx` or `Caddyserver` and configure it as a reverse proxy for both Grafana and ZTE web GUIs (the later is required to set the `Referer` header)\r\n4. import `mobilebroadband.json` dashboard and modify it to suit your needs or build your own from scratch (change URLs to suit your environment)\r\n\r\n````\r\npi@localhost ~ $ cat /etc/nginx/sites-enabled/grafana\r\nserver {\r\n\r\n\tlisten 80;\r\n\tserver_name <your_host_name>;\r\n\r\n\tlocation / {\r\n\t\tproxy_pass http://localhost:3000/;\r\n\t}\r\n\r\n\tlocation /public/ {\r\n\t\talias /usr/share/grafana/public/;\r\n\t}\r\n\r\n\tlocation /goform/ {\r\n\t\tproxy_set_header Referer http://<your_ZTE-MF823_modem_IP>/;\r\n\t\tproxy_pass http://<your_ZTE-MF823_modem_IP>:80/goform/;\r\n\t}\r\n}\r\n````\r\n\r\nThe ZTE MF823 has a REST API apart from the web GUI, which we are using to communicate with the modem from within the Grafana dashboard. The full list of command sisn't published, but looking at the modem's web interface with Chrome Developer Tools, the following commands were evident.\r\n\r\n```\r\n# connect mobile network (HTTP GET)\r\nhttp://<modem_IP>/goform//goform_set_cmd_process?isTest=false&notCallback=true&goformId=CONNECT_NETWORK\r\n\r\n# disconnect mobile network (HTTP GET)\r\nhttp://<modem_IP>/goform//goform_set_cmd_process?isTest=false&notCallback=true&goformId=DISCONNECT_NETWORK\r\n\r\n# modem state (HTTP GET)\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?multi_data=1&isTest=false&sms_received_flag_flag=0&sts_received_flag_flag=0&cmd=modem_main_state%2Cpin_status%2Cloginfo%2Cnew_version_state%2Ccurrent_upgrade_state%2Cis_mandatory%2Csms_received_flag%2Csts_received_flag%2Csignalbar%2Cnetwork_type%2Cnetwork_provider%2Cppp_status%2CEX_SSID1%2Cex_wifi_status%2CEX_wifi_profile%2Cm_ssid_enable%2Csms_unread_num%2CRadioOff%2Csimcard_roam%2Clan_ipaddr%2Cstation_mac%2Cbattery_charging%2Cbattery_vol_percent%2Cbattery_pers%2Cspn_display_flag%2Cplmn_display_flag%2Cspn_name_data%2Cspn_b1_flag%2Cspn_b2_flag%2Crealtime_tx_bytes%2Crealtime_rx_bytes%2Crealtime_time%2Crealtime_tx_thrpt%2Crealtime_rx_thrpt%2Cmonthly_rx_bytes%2Cmonthly_tx_bytes%2Cmonthly_time%2Cdate_month%2Cdata_volume_limit_switch%2Cdata_volume_limit_size%2Cdata_volume_alert_percent%2Cdata_volume_limit_unit%2Croam_setting_option%2Cupg_roam_switch%2Chplmn\r\n\r\n# ConnectionMode (dial mode auto|manual)\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=ConnectionMode\r\n\r\n# enable roaming\r\nhttp://<modem_IP>/goform/goform_set_cmd_process?isTest=false&notCallback=true&goformId=SET_CONNECTION_MODE&roam_setting_option=on\r\n\r\n# disable roaming\r\nhttp://<modem_IP>/goform/goform_set_cmd_process?isTest=false&notCallback=true&goformId=SET_CONNECTION_MODE&roam_setting_option=off\r\n\r\n# enable auto-dial\r\nhttp://<modem_IP>/goform/goform/goform_set_cmd_process?isTest=false&notCallback=true&goformId=SET_CONNECTION_MODE&ConnectionMode=auto_dial\r\n\r\n# disable auto-dial\r\nhttp://<modem_IP>/goform/goform/goform_set_cmd_process?isTest=false&notCallback=true&goformId=SET_CONNECTION_MODE&ConnectionMode=manual_dial\r\n\r\n# upgrade_result\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=upgrade_result\r\n\r\n# current_upgrade_state\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=current_upgrade_state\r\n\r\n# sms_data_total\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=sms_data_total&page=0&data_per_page=500&mem_store=1&tags=10&order_by=order+by+id+desc\r\n\r\n# sms_capacity_info\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=sms_capacity_info\r\n\r\n# sms_parameter_info\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=sms_parameter_info\r\n\r\n# pbm_init_flag\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=pbm_init_flag\r\n\r\n# pbm_capacity_info&pbm_location=pbm_sim\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=pbm_capacity_info&pbm_location=pbm_sim\r\n\r\n# mem__data_total\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&mem_store=2&cmd=pbm_data_total&page=0&data_per_page=2000&orderBy=name&isAsc=true\r\n\r\n# m_ssid_enable\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=m_ssid_enable%2CSSID1%2CAuthMode%2CHideSSID%2CWPAPSK1%2CMAX_Access_num%2CEncrypType%2Cm_SSID%2Cm_AuthMode%2Cm_HideSSID%2Cm_WPAPSK1%2Cm_MAX_Access_num%2Cm_EncrypType&multi_data=1\r\n\r\n# pbm_capacity_info&pbm_location=pbm_native\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=pbm_capacity_info&pbm_location=pbm_native\r\n\r\n# sim_imsi\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&multi_data=1&cmd=sim_imsi%2Csim_imsi_lists\r\n\r\n# wifi_coverage\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=wifi_coverage%2Cm_ssid_enable%2Cimei%2Cweb_version%2Cwa_inner_version%2Chardware_version%2CMAX_Access_num%2CSSID1%2Cm_SSID%2Cm_HideSSID%2Cm_MAX_Access_num%2Clan_ipaddr%2Cwan_active_band%2Cmac_address%2Cmsisdn%2CLocalDomain%2Cwan_ipaddr%2Cipv6_wan_ipaddr%2Cipv6_pdp_type%2Cpdp_type%2Cppp_status%2Csim_iccid%2Csim_imsi%2Crmcc%2Crmnc%2Crssi%2Crscp%2Clte_rsrp%2Cecio%2Clte_snr%2Cnetwork_type%2Clte_rssi%2Clac_code%2Ccell_id%2Clte_pci%2Cdns_mode%2Cprefer_dns_manual%2Cstandby_dns_manual%2Cprefer_dns_auto%2Cstandby_dns_auto%2Cipv6_dns_mode%2Cipv6_prefer_dns_manual%2Cipv6_standby_dns_manual%2Cipv6_prefer_dns_auto%2Cipv6_standby_dns_auto%2Cmodel_name&multi_data=1\r\n\r\n# current_network_mode\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=current_network_mode%2Cm_netselect_save%2Cnet_select_mode%2Cm_netselect_contents%2Cnet_select%2Cppp_status%2Cmodem_main_state%2Clte_band_lock%2Cwcdma_band_lock&multi_data=1\r\n\r\n# APN_config0\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=APN_config0%2CAPN_config1%2CAPN_config2%2CAPN_config3%2CAPN_config4%2CAPN_config5%2CAPN_config6%2CAPN_config7%2CAPN_config8%2CAPN_config9%2CAPN_config10%2CAPN_config11%2CAPN_config12%2CAPN_config13%2CAPN_config14%2CAPN_config15%2CAPN_config16%2CAPN_config17%2CAPN_config18%2CAPN_config19%2Cipv6_APN_config0%2Cipv6_APN_config1%2Cipv6_APN_config2%2Cipv6_APN_config3%2Cipv6_APN_config4%2Cipv6_APN_config5%2Cipv6_APN_config6%2Cipv6_APN_config7%2Cipv6_APN_config8%2Cipv6_APN_config9%2Cipv6_APN_config10%2Cipv6_APN_config11%2Cipv6_APN_config12%2Cipv6_APN_config13%2Cipv6_APN_config14%2Cipv6_APN_config15%2Cipv6_APN_config16%2Cipv6_APN_config17%2Cipv6_APN_config18%2Cipv6_APN_config19%2Cm_profile_name%2Cprofile_name%2Cwan_dial%2Capn_select%2Cpdp_type%2Cpdp_select%2Cpdp_addr%2Cindex%2CCurrent_index%2Capn_auto_config%2Cipv6_apn_auto_config%2Capn_mode%2Cwan_apn%2Cppp_auth_mode%2Cppp_username%2Cppp_passwd%2Cdns_mode%2Cprefer_dns_manual%2Cstandby_dns_manual%2Cipv6_wan_apn%2Cipv6_pdp_type%2Cipv6_ppp_auth_mode%2Cipv6_ppp_username%2Cipv6_ppp_passwd%2Cipv6_dns_mode%2Cipv6_prefer_dns_manual%2Cipv6_standby_dns_manual&multi_data=1\r\n\r\n# lan_ipaddr\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=lan_ipaddr%2Clan_netmask%2Cmac_address%2CdhcpEnabled%2CdhcpStart%2CdhcpEnd%2CdhcpLease_hour&multi_data=1\r\n\r\n# DMZEnable\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=DMZEnable%2CDMZIPAddress&multi_data=1\r\n\r\n# PortMapEnable\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=PortMapEnable%2CPortMapRules_0%2CPortMapRules_1%2CPortMapRules_2%2CPortMapRules_3%2CPortMapRules_4%2CPortMapRules_5%2CPortMapRules_6%2CPortMapRules_7%2CPortMapRules_8%2CPortMapRules_9&multi_data=1\r\n\r\n# IPPortFilterEnable\r\nhttp://<modem_IP>/goform/goform_get_cmd_process?isTest=false&cmd=IPPortFilterEnable%2CDefaultFirewallPolicy%2CIPPortFilterRules_0%2CIPPortFilterRules_1%2CIPPortFilterRules_2%2CIPPortFilterRules_3%2CIPPortFilterRules_4%2CIPPortFilterRules_5%2CIPPortFilterRules_6%2CIPPortFilterRules_7%2CIPPortFilterRules_8%2CIPPortFilterRules_9%2CIPPortFilterRulesv6_0%2CIPPortFilterRulesv6_1%2CIPPortFilterRulesv6_2%2CIPPortFilterRulesv6_3%2CIPPortFilterRulesv6_4%2CIPPortFilterRulesv6_5%2CIPPortFilterRulesv6_6%2CIPPortFilterRulesv6_7%2CIPPortFilterRulesv6_8%2CIPPortFilterRulesv6_9&multi_data=1\r\n```\r\n\r\nAll the API requests require the `Referer: http://<your_ZTE-MF823_modem_IP>/` request header present. No additional headers are required.\r\n\r\n#### GPS Dashboard\r\n\r\n![GPS dashboard](https://raw.githubusercontent.com/ab77/beastcraft-telemetry/master/static/gps.png)\r\n\r\n1. install `gpsd` ([docs](http://www.catb.org/gpsd/)) using [this](http://www.danmandle.com/blog/getting-gpsd-to-work-with-python/) or [this](http://blog.perrygeo.net/2007/05/27/python-gpsd-bindings/) guide.\r\n2. add `geo.conf` to `/etc/supervisor/conf.d/` and reload `supervisor` process\r\n3. import `gps.json` dashboard and modify it to suit your needs or build your own from scratch\r\n\r\nTo synchronise time using GPS receiver and NTP, read the following concise article [Connecting u-blox NEO-6M GPS to Raspberry Pi](https://bigdanzblog.wordpress.com/2015/01/18/connecting-u-blox-neo-6m-gps-to-raspberry-pi/).\r\n\r\n#### FortiWifi Interface Monitor\r\n\r\nA `FortiWifi` firewall can be configured as a wireless bridge as follows[n1]:\r\n\r\n```\r\nconfig system global\r\n    set wireless-mode client\r\nend\r\n```\r\n\r\nA side effect of doing this, is that the resulting `wifi` internal interface is always up, regardless of whether or not it is connected to the upstream wireless network. This means that if a backup interface is to be used (e.g. Mobile Broadband), the `wifi` interface default route will never be released and the backup one will never kick in. A less elegant solution is to use FortiOS `link-monitor` function in conjunction with a custom script running somewhere nearby to manipulate network routes depending on interface availability.\r\n\r\nFor example, if a `wifi` interface is used as a primary network link and a `wan2` interface is used for backup, the following `link-monitor` configuration is set on the device:\r\n\r\n```\r\nconfig system link-monitor\r\n    edit \"wan2\"\r\n        set srcintf \"wan2\"\r\n        set server \"8.8.8.8\" \"8.8.4.4\"\r\n    next\r\n    edit \"wifi\"\r\n        set srcintf \"wifi\"\r\n        set server \"8.8.8.8\" \"8.8.4.4\"\r\n    next\r\nend\r\n````\r\n\r\nStatus check is performed for running `diag sys link-monitor status wifi` command and inspecting the output:\r\n\r\n```\r\nLink Monitor: wifi Status: alive Create time: Fri Mar 18 14:55:41 2016\r\nSource interface: wifi (18)\r\nInterval: 5, Timeout 1\r\nFail times: 0/5\r\nSend times: 0\r\n  Peer: 8.8.4.4(8.8.4.4)\r\n        Source IP(172.16.99.11)\r\n        Route: 172.16.99.11->8.8.4.4/32, gwy(172.16.99.254)\r\n    protocol: ping, state: alive\r\n              Latency(recent/average): 20.55/23.82 ms Jitter: 267.41\r\n              Recovery times(0/5)\r\n              Continuous sending times after the first recovery time 0\r\n              Packet sent: 172173  Packet received: 167884\r\n  Peer: 8.8.8.8(8.8.8.8)\r\n        Source IP(172.16.99.11)\r\n        Route: 172.16.99.11->8.8.8.8/32, gwy(172.16.99.254)\r\n    protocol: ping, state: alive\r\n              Latency(recent/average): 20.41/29.20 ms Jitter: 266.55\r\n              Recovery times(1/5)\r\n              Continuous sending times after the first recovery time 1\r\n              Packet sent: 172161  Packet received: 169386\r\n```\r\n\r\nTo automate this, I've written a simple Python script, which can be run on a nearby Linux host, to poll the firewall every few seconds and check the interface status. Should the primary interface go down, the script modifies the default route to send traffic to the backup interface:\r\n\r\n```\r\nusage: monitor.py [-h] --host HOST [--port PORT] [--user USER] --iface IFACE\r\n                  --backup BACKUP --gwip GWIP\r\n\r\nFortiGate interface monitor\r\n\r\noptional arguments:\r\n  -h, --help       show this help message and exit\r\n  --host HOST      FortiGate appliance hostname or IP\r\n  --port PORT      SSH port of the FortiGate appliance\r\n  --user USER      FortiGate admin username\r\n  --iface IFACE    FortiGate interface to monitor (e.g. wifi)\r\n  --backup BACKUP  FortiGate interface to fail-over to (e.g. wan2)\r\n  --gwip GWIP      Backup interface gateway ipaddr\r\n```\r\n\r\n[![ab1](https://avatars2.githubusercontent.com/u/2033996?v=3&s=96)](http://ab77.github.io/)\r\n\r\n###### Footnotes\r\n\r\n[n1] [FortiWifi Client mode (wireless bridge)](https://stuff.purdon.ca/?page_id=183)\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}